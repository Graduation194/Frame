<script>
  const canvasEl = document.getElementById('canvas');
  const container = document.getElementById('canvas-container');
  const DEFAULT_CANVAS_SIZE = 768;

  const canvas = new fabric.Canvas('canvas', {
    backgroundColor: '#ffffff',
    preserveObjectStacking: true,
  });

  let frameImage = null;
  let userImage = null;
  let frameOriginalWidth = DEFAULT_CANVAS_SIZE;
  let frameOriginalHeight = DEFAULT_CANVAS_SIZE;

  function resizeCanvas() {
    const size = Math.min(container.offsetWidth, window.innerWidth * 0.95);
    canvasEl.width = size;
    canvasEl.height = size;
    canvas.setWidth(size);
    canvas.setHeight(size);

    if (frameImage) {
      frameImage.scaleToWidth(size);
    }

    if (userImage) {
      const scale = size / userImage._originalWidth;
      userImage.scale(scale);
    }

    canvas.renderAll();
  }

  function loadFrame() {
    fabric.Image.fromURL('frame.png', function(img) {
      frameImage = img;
      frameOriginalWidth = img.width;
      frameOriginalHeight = img.height;

      img.set({
        left: 0,
        top: 0,
        selectable: false,
        evented: false
      });

      img.scaleToWidth(canvas.getWidth());
      canvas.add(img);
      canvas.sendToBack(img);
      resizeCanvas();
    }, { crossOrigin: 'anonymous' });
  }

  function loadUserImage(url) {
    fabric.Image.fromURL(url, function(img) {
      if (userImage) canvas.remove(userImage);

      userImage = img;
      userImage._originalWidth = img.width;
      userImage._originalHeight = img.height;

      const scale = canvas.getWidth() / img.width;
      img.scale(scale);

      img.set({
        left: 0,
        top: 0,
        hasControls: true,
        lockUniScaling: true,
        lockRotation: true,
        cornerStyle: 'circle',
        borderColor: '#2f1a23',
        cornerColor: '#2f1a23',
        transparentCorners: false,
        clipPath: new fabric.Rect({
          left: 0,
          top: 0,
          width: canvas.getWidth(),
          height: canvas.getHeight(),
          absolutePositioned: true
        })
      });

      canvas.add(img);
      canvas.setActiveObject(img);
      canvas.sendToBack(img);
      if (frameImage) canvas.bringToFront(frameImage);
    }, { crossOrigin: 'anonymous' });
  }

  document.getElementById('upload').addEventListener('change', function (e) {
    const reader = new FileReader();
    reader.onload = function (f) {
      loadUserImage(f.target.result);
    };
    reader.readAsDataURL(e.target.files[0]);
  });

  document.getElementById('download').addEventListener('click', function () {
    canvas.discardActiveObject();
    canvas.renderAll();

    // نحفظ الحجم الأصلي
    const originalWidth = canvas.getWidth();
    const originalHeight = canvas.getHeight();

    // نحول الكانفس لدقة الفريم
    canvas.setWidth(frameOriginalWidth);
    canvas.setHeight(frameOriginalHeight);
    canvas.setZoom(frameOriginalWidth / originalWidth);

    canvas.renderAll();

    const dataURL = canvas.toDataURL({
      format: 'png',
      multiplier: 1
    });

    // نرجع الكانفس للحجم العادي
    canvas.setZoom(1);
    canvas.setWidth(originalWidth);
    canvas.setHeight(originalHeight);
    resizeCanvas();

    // تحميل الصورة
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = 'graduation_frame.png';
    link.click();
  });

  canvas.on('touch:gesture', function(opt) {
    const obj = canvas.getActiveObject();
    if (opt.e.touches && opt.e.touches.length === 2 && obj) {
      const delta = opt.self.scale;
      obj.scale(obj.scaleX * delta);
      canvas.requestRenderAll();
    }
  });

  window.addEventListener('resize', resizeCanvas);
  loadFrame();
</script>
